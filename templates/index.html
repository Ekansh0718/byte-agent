<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BYTE | AI Voice Agent</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2 class="logo">⚡ BYTE</h2>
      <button onclick="askNews()">📰 Tech News</button>
      <button onclick="askWeather()">☁️ Weather</button>
    </aside>

    <!-- Main Section -->
    <main class="main">
      <header>
        <h1>BYTE Voice Agent</h1>
      </header>

      <!-- Chat -->
      <div id="chat" class="chat"></div>

      <!-- Controls -->
      <div class="controls">
        <input id="userInput" type="text" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
        <button onclick="startRecording()">🎙</button>
      </div>

      <!-- Config -->
      <div class="config">
        <h3>🔑 API Keys</h3>
        <input id="assemblyKey" placeholder="AssemblyAI Key">
        <input id="geminiKey" placeholder="Gemini Key">
        <input id="newsKey" placeholder="NewsAPI Key">
        <input id="weatherKey" placeholder="OpenWeather Key">
        <input id="murfKey" placeholder="Murf API Key">
        <button onclick="saveConfig()">Save Config</button>
      </div>
    </main>
  </div>

  <script>
    let ws = new WebSocket(`ws://${location.host}/ws`);
    let audioPlayer = new Audio();
    let mediaRecorder, audioChunks = [];

    ws.onmessage = (event) => {
      let msg = JSON.parse(event.data);

      if (msg.type === "system") addMessage("🛠 System", msg.text);
      else if (msg.type === "user") addMessage("🧑 You", msg.text);
      else if (msg.type === "assistant") addMessage("🤖 BYTE", msg.text);
      else if (msg.type === "audio") {
        let audioData = atob(msg.b64);
        let buffer = new Uint8Array(audioData.length);
        for (let i = 0; i < audioData.length; i++) buffer[i] = audioData.charCodeAt(i);
        let blob = new Blob([buffer], { type: "audio/mp3" });
        let url = URL.createObjectURL(blob);
        audioPlayer.src = url;
        audioPlayer.play();
      }
    };

    function addMessage(sender, text) {
      let chat = document.getElementById("chat");
      let div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<b>${sender}:</b> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function saveConfig() {
      let keys = {
        assembly: document.getElementById("assemblyKey").value,
        gemini: document.getElementById("geminiKey").value,
        news: document.getElementById("newsKey").value,
        weather: document.getElementById("weatherKey").value,
        murf: document.getElementById("murfKey").value,
      };
      ws.send(JSON.stringify({ type: "config", keys: keys }));
    }

    function sendMessage() {
      let input = document.getElementById("userInput");
      if (input.value.trim() !== "") {
        ws.send(JSON.stringify({ type: "final", text: input.value }));
        input.value = "";
      }
    }

    async function startRecording() {
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        let blob = new Blob(audioChunks, { type: "audio/webm" });
        let arrayBuffer = await blob.arrayBuffer();
        let base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
        ws.send(JSON.stringify({ type: "audio_input", b64: base64Audio }));
      };

      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 5000); // 🎙 5 sec record
    }

    // New Sidebar Features
    function askNews() {
      ws.send(JSON.stringify({ type: "skill", name: "news" }));
    }

    function askWeather() {
      ws.send(JSON.stringify({ type: "skill", name: "weather" }));
    }
  </script>
</body>
</html>
